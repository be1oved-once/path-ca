<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin â€“ Notifications</title>

  <link rel="stylesheet" href="/assets/css/common.css">

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">

  <link rel="stylesheet"
        href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
<link rel="icon" type="image/png" sizes="16x16" href="/assets/favicon/favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="/assets/favicon/favicon-32x32.png">
<link rel="icon" href="/assets/favicon/favicon.ico">

<link rel="apple-touch-icon" sizes="180x180" href="/assets/favicon/apple-touch-icon.png">

<link rel="icon" type="image/png" sizes="192x192" href="/assets/favicon/android-chrome-192x192.png">
<link rel="icon" type="image/png" sizes="512x512" href="/assets/favicon/android-chrome-512x512.png">

<link rel="manifest" href="/assets/favicon/site.webmanifest">
<style>
  /* =========================
   ROOT THEME VARIABLES
========================= */

:root {
  --bg: #ffffff;
  --panel: #f8fafc;
  --border: #e5e7eb;
  --text: #111827;
  --muted: #6b7280;

  --primary: #6c63ff;
  --danger: #dc2626;
}

body.dark {
  --bg: #0f172a;
  --panel: #020617;
  --border: rgba(255,255,255,0.12);
  --text: #e5e7eb;
  --muted: #94a3b8;

  --primary: #7c6fff;
  --danger: #f87171;
}

/* =========================
   PAGE BASE
========================= */

body {
  margin: 0;
  font-family: "Poppins", system-ui, sans-serif;
  background: var(--bg);
  color: var(--text);
}

/* =========================
   ADMIN LAYOUT
========================= */

.admin-box {
  max-width: 440px;

  /* ðŸ‘‡ header (56px) + breathing room */
  margin-top: calc(56px + 20px);

  /* ðŸ‘‡ leave space from left sidebar */
  
  margin-right: auto;

  padding: 18px;
  border-radius: 16px;

  background: var(--panel);
  border: 1.5px solid var(--border);

  box-shadow: 0 12px 30px rgba(0,0,0,0.08);
}

/* Center on small screens */
@media (max-width: 768px) {
  .admin-box {
    margin-right: auto;
    margin-top: calc(56px + 14px);
    width: calc(100% - 40px);
  }
}

/* =========================
   HEADINGS
========================= */

.admin-box h2 {
  font-size: 18px;
  font-weight: 600;
  margin-bottom: 12px;
}

.admin-box h3 {
  font-size: 14px;
  font-weight: 600;
  margin-bottom: 10px;
  color: var(--muted);
}

/* =========================
   TEXTAREA
========================= */

textarea {
  width: 100%;
  min-height: 90px;

  padding: 10px 12px;
  border-radius: 12px;

  border: 1.5px solid var(--border);
  background: var(--bg);
  color: var(--text);

  font-size: 14px;
  resize: none;
  outline: none;
}

textarea::placeholder {
  color: var(--muted);
}

/* =========================
   PRIMARY BUTTON
========================= */

#sendBtn {
  width: 100%;
  margin-top: 12px;
  padding: 10px 14px;

  border-radius: 999px;
  border: none;

  background: linear-gradient(135deg, var(--primary), #8b5cf6);
  color: #fff;

  font-weight: 600;
  cursor: pointer;

  transition: transform 0.18s ease, box-shadow 0.18s ease;
}

#sendBtn:hover {
  box-shadow: 0 8px 22px rgba(108,99,255,0.4);
}

#sendBtn:active {
  transform: scale(0.97);
}

/* =========================
   DIVIDER
========================= */

hr {
  margin: 18px 0;
  border: none;
  border-top: 1px dashed var(--border);
}

/* =========================
   NOTIFICATION LIST
========================= */

#list {
  display: flex;
  flex-direction: column;
  gap: 8px;
}

/* =========================
   NOTIFICATION ROW
========================= */

.notification-row {
  display: grid;
  grid-template-columns: 1fr auto; /* ðŸ‘ˆ perfect alignment */
  align-items: center;
  gap: 10px;

  padding: 10px 12px;
  border-radius: 12px;

  background: var(--bg);
  border: 1.5px solid var(--border);
}

/* Text */
.notification-row span {
  font-size: 13px;
  line-height: 1.4;
  color: var(--text);
}

/* =========================
   DELETE BUTTON
========================= */

.notification-row button {
  padding: 6px 12px;
  border-radius: 999px;
  border: none;

  background: var(--danger);
  color: #fff;

  font-size: 12px;
  font-weight: 600;
  cursor: pointer;

  transition: transform 0.15s ease, box-shadow 0.15s ease;
}

.notification-row button:hover {
  box-shadow: 0 6px 14px rgba(220,38,38,0.4);
}

.notification-row button:active {
  transform: scale(0.95);
}
/* =========================
   CONFIRM TOAST
========================= */

.confirm-toast {
  position: fixed;
  bottom: 18px;
  left: 50%;
  transform: translateX(-50%) translateY(120%);

  width: calc(100% - 32px);
  max-width: 420px;

  background: var(--panel);
  border: 1.5px solid var(--border);
  border-radius: 14px;

  padding: 14px 16px;

  box-shadow: 0 14px 40px rgba(0,0,0,0.25);

  display: flex;
  flex-direction: column;
  gap: 12px;

  transition: transform 0.35s cubic-bezier(.25,.8,.25,1);
  z-index: 2000;
}

/* SHOW */
.confirm-toast.show {
  transform: translateX(-50%) translateY(0);
}

/* TEXT */
.confirm-toast p {
  font-size: 14px;
  font-weight: 500;
  color: var(--text);
  margin: 0;
}

/* ACTIONS */
.confirm-actions {
  display: flex;
  justify-content: flex-end;
  gap: 10px;
}

/* CANCEL */
.btn-cancel {
  background: transparent;
  border: 1.5px solid var(--border);
  color: var(--text);

  padding: 6px 14px;
  border-radius: 999px;
  font-size: 13px;
  cursor: pointer;
}

/* DELETE */
.btn-danger {
  background: var(--danger);
  color: #fff;
  border: none;

  padding: 6px 16px;
  border-radius: 999px;
  font-size: 13px;
  font-weight: 600;
  cursor: pointer;
}

.btn-danger:hover {
  box-shadow: 0 6px 14px rgba(220,38,38,0.4);
}
/* =========================
   ADMIN HISTORY
========================= */
.history-list {
  margin-top: 10px;
  display: flex;
  flex-direction: column;
  gap: 8px;
}

.history-item {
  padding: 10px;
  border-radius: 12px;
  background: #020617;
  border: 1px solid #334155;
  font-size: 13px;
}

.history-item.deleted {
  opacity: 0.55;
  border-style: dashed;
}

.history-item small {
  display: block;
  opacity: 0.65;
  font-size: 11px;
  margin-top: 4px;
}

.clear-history-btn {
  margin-top: 12px;
  padding: 8px;
  width: 100%;
  border-radius: 999px;
  border: 1px solid #dc2626;
  background: transparent;
  color: #dc2626;
  font-weight: 600;
  cursor: pointer;
}

.clear-history-btn:hover {
  background: rgba(220,38,38,0.12);
}
.history-row {
  display: flex;
  justify-content: space-between;
  gap: 10px;
  align-items: center;
}

.history-del {
  padding: 4px 10px;
  font-size: 11px;
  border-radius: 999px;
  border: 1px solid #dc2626;
  background: transparent;
  color: #dc2626;
  cursor: pointer;
}

.history-del:hover {
  background: rgba(220,38,38,0.15);
}
/* =========================
   ADMIN PAGE SPACING FIX
========================= */

.admin-box {
  margin-left: 8vw;
}

/* Desktop refinement */
@media (min-width: 768px) {
  .admin-box {
    margin-left: auto;
    margin-right: auto;
  }
}
/* =========================
   LIGHT MODE OVERRIDES
========================= */
body:not(.dark) .history-item {
  background: #ffffff;
  border: 1px solid #e5e7eb;
  color: #1f2937;
}

body:not(.dark) .history-item.deleted {
  opacity: 0.6;
  border-style: dashed;
}

body:not(.dark) .history-item small {
  color: #6b7280;
}
.history-row {
  display: flex;
  align-items: center;
  justify-content: space-between;
  gap: 10px;
}

/* Prevent text overflow */
.history-row span {
  flex: 1;
  line-height: 1.35;
}
body:not(.dark) .history-del {
  border-color: #dc2626;
  color: #dc2626;
}

body:not(.dark) .history-del:hover {
  background: rgba(220,38,38,0.12);
}
body:not(.dark) .clear-history-btn {
  border-color: #dc2626;
  color: #dc2626;
}

body:not(.dark) .clear-history-btn:hover {
  background: rgba(220,38,38,0.1);
}
/* =========================
   TOAST BACKDROP (DIM)
========================= */
.toast-backdrop {
  position: fixed;
  inset: 0;
  background: rgba(15, 23, 42, 0.45);
  backdrop-filter: blur(3px);
  -webkit-backdrop-filter: blur(3px);
  opacity: 0;
  pointer-events: none;
  transition: opacity 0.25s ease;
  z-index: 1999;
}

.toast-backdrop.show {
  opacity: 1;
  pointer-events: auto;
}
.target-email {
  width: 100%;
  padding: 8px 12px;
  border-radius: 10px;
  border: 1.5px solid var(--border);
  background: var(--bg);
  color: var(--text);
  font-size: 13px;
  margin-bottom: 8px;
}
</style>
</head>

<body>

  <div class="admin-box">
    <h2>ðŸ”” Push Notification</h2>
<input id="targetEmail" class="target-email"
 placeholder="Send to specific user (optional)">
    <textarea id="msgInput"
      placeholder="Enter notification message..."
      maxlength="200"></textarea>

    <button id="sendBtn">Send Notification</button>

    <hr>

    <h3>Active Notifications</h3>
    <div id="list"></div>
    <hr>

<h3>Admin Notification History</h3>

<div id="historyList" class="history-list"></div>

<button id="clearHistoryBtn" class="clear-history-btn">
  Clear Local History
</button>
  </div>

  <!-- âœ… DELETE CONFIRM TOAST -->
  <div id="confirmToast" class="confirm-toast">
    <p id="confirmText">Are you sure?</p>

    <div class="confirm-actions">
      <button id="confirmCancel" class="btn-cancel">Cancel</button>
      <button id="confirmYes" class="btn-danger">Delete</button>
    </div>
  </div>
<div id="toastBackdrop" class="toast-backdrop"></div>
<script type="module">
  import { auth, db } from "../assets/js/firebase.js";
import { onAuthStateChanged } from
  "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";

import {
  collection,
  addDoc,
  query,
  orderBy,
  onSnapshot,
  deleteDoc,
  doc,
  serverTimestamp
} from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

/* =========================
   ADMIN CONFIG
========================= */
const ADMIN_EMAILS = [
  "nicknow20@gmail.com",
  "saurabhjoshionly@gmail.com",
  "contact.globalratings@gmail.com"
];

/* =========================
   UI
========================= */
const msgInput = document.getElementById("msgInput");
const sendBtn  = document.getElementById("sendBtn");
const list     = document.getElementById("list");

/* =========================
   ADMIN LOCAL HISTORY
========================= */
const ADMIN_HISTORY_KEY = "admin_notify_history";

function getAdminHistory() {
  try {
    return JSON.parse(localStorage.getItem(ADMIN_HISTORY_KEY)) || [];
  } catch {
    return [];
  }
}

function saveAdminHistory(data) {
  localStorage.setItem(ADMIN_HISTORY_KEY, JSON.stringify(data));
}

/* =========================
   AUTH CHECK
========================= */
onAuthStateChanged(auth, user => {
  if (!user) {
    location.href = "/";
    return;
  }

  if (!ADMIN_EMAILS.includes(user.email)) {
  location.href = "/";
}
});

/* =========================
   ADD NOTIFICATION
========================= */
const targetEmailInput = document.getElementById("targetEmail");

sendBtn.addEventListener("click", async () => {
  const message = msgInput.value.trim();
  const emailTarget = targetEmailInput.value.trim();

  if (!message) return;

  const isTargeted = emailTarget.length > 0;

  await addDoc(collection(db, "notifications"), {
    message,
    target: isTargeted ? "user" : "global",
    email: isTargeted ? emailTarget.toLowerCase() : null,
    createdAt: serverTimestamp()
  });

  // Local admin history
  const history = getAdminHistory();
  history.unshift({
    message,
    createdAt: Date.now(),
    deletedAt: null,
    target: isTargeted ? emailTarget : "global"
  });
  saveAdminHistory(history);

  msgInput.value = "";
  targetEmailInput.value = "";
});

/* =========================
   LIVE LIST
========================= */
const q = query(
  collection(db, "notifications"),
  orderBy("createdAt", "desc")
);

onSnapshot(q, snap => {
  list.innerHTML = "";

  if (snap.empty) {
    list.innerHTML = "<p style='opacity:.6'>No notifications</p>";
    return;
  }

  snap.forEach(d => {
    const data = d.data();

    const row = document.createElement("div");
    row.className = "notification-row";

    row.innerHTML = `
      <span>${data.message}</span>
      <button class="delete-btn">Delete</button>
    `;

    row.querySelector(".delete-btn").onclick = () => {
      showConfirmToast(
        "Delete this notification permanently?",
        async () => {
          await deleteDoc(doc(db, "notifications", d.id));

          // ðŸ” Update local history
          const history = getAdminHistory();
          const item = history.find(h =>
            h.message === data.message && !h.deletedAt
          );
          if (item) item.deletedAt = Date.now();
          saveAdminHistory(history);
          renderAdminHistory(); // âœ… ADD THIS
        }
      );
    };

    list.appendChild(row);
  });
});

/* =========================
   CONFIRM TOAST
========================= */
const confirmToast  = document.getElementById("confirmToast");
const confirmText   = document.getElementById("confirmText");
const confirmYes    = document.getElementById("confirmYes");
const confirmCancel = document.getElementById("confirmCancel");

let confirmAction = null;

function showConfirmToast(message, action) {
  confirmText.textContent = message;
  confirmAction = action;
  confirmToast.classList.add("show");
  document.getElementById("toastBackdrop")?.classList.add("show");
}

function hideConfirmToast() {
  confirmToast.classList.remove("show");
  confirmAction = null;
  document.getElementById("toastBackdrop")?.classList.remove("show");
}

confirmCancel.onclick = hideConfirmToast;

confirmYes.onclick = async () => {
  if (confirmAction) await confirmAction();
  hideConfirmToast();
};
/* =========================
   RENDER ADMIN HISTORY
========================= */
const historyList = document.getElementById("historyList");
const clearHistoryBtn = document.getElementById("clearHistoryBtn");

function renderAdminHistory() {
  if (!historyList) return;

  const history = getAdminHistory();
  historyList.innerHTML = "";

  if (history.length === 0) {
    historyList.innerHTML =
      "<p style='opacity:.6'>No local history</p>";
    return;
  }

  history.forEach(item => {
    const div = document.createElement("div");
    div.className = "history-item" + (item.deletedAt ? " deleted" : "");

    div.innerHTML = `
  <div class="history-row">
    <span>
  ${item.message}
  <small style="display:block;opacity:.6">
    Target: ${item.target || "global"}
  </small>
</span>
    <button class="history-del">Delete</button>
  </div>

  <small>
    Sent: ${new Date(item.createdAt).toLocaleString()}
    ${item.deletedAt
      ? `<br>Deleted: ${new Date(item.deletedAt).toLocaleString()}`
      : ""}
  </small>
`;
div.querySelector(".history-del").onclick = () => {
  showConfirmToast(
    "Remove this notification from local history?",
    () => {
      const history = getAdminHistory().filter(
        h => h.createdAt !== item.createdAt
      );
      saveAdminHistory(history);
      renderAdminHistory();
    }
  );
};

    historyList.appendChild(div);
  });
}

/* Clear history */
clearHistoryBtn?.addEventListener("click", () => {
  if (!confirm("Clear admin local history?")) return;
  localStorage.removeItem(ADMIN_HISTORY_KEY);
  renderAdminHistory();
});

/* Initial render */
renderAdminHistory();

</script>
  <!-- Common layout & auth -->
  <script src="/assets/js/common-layout.js"></script>
  <script type="module" src="/assets/js/firebase.js"></script>
  <script type="module" src="/assets/js/common.js"></script>

</body>
</html>